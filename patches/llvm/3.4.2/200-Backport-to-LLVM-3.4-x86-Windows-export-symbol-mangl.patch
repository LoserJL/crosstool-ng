From 71d15cf4733768bdbcd5f8ffda1785cd62648f5f Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Tue, 11 Oct 2016 09:33:23 +0100
Subject: [PATCH 6/7] Backport to LLVM 3.4 x86 Windows export symbol mangling

---
 lib/Target/X86/X86AsmPrinter.cpp | 39 ++++++++++++++++++++++-----------------
 lib/Target/X86/X86AsmPrinter.h   |  2 ++
 2 files changed, 24 insertions(+), 17 deletions(-)

diff --git a/lib/Target/X86/X86AsmPrinter.cpp b/lib/Target/X86/X86AsmPrinter.cpp
index 1f5f918..d71f5f2 100644
--- a/lib/Target/X86/X86AsmPrinter.cpp
+++ b/lib/Target/X86/X86AsmPrinter.cpp
@@ -544,6 +544,26 @@ void X86AsmPrinter::EmitStartOfAsmFile(Module &M) {
   }
 }
 
+void X86AsmPrinter::GenerateExportDirective(const MCSymbol *Sym, bool IsData) {
+  SmallString<128> name;
+
+  if (Subtarget->isTargetWindows())
+    name += " /EXPORT:";
+  else
+    name += " -export:";
+
+  name += Sym->getName();
+
+  if (IsData) {
+    if (Subtarget->isTargetWindows())
+      name += ",DATA";
+    else
+      name += ",data";
+  }
+
+  OutStreamer.EmitBytes(name);
+}
+
 
 void X86AsmPrinter::EmitEndOfAsmFile(Module &M) {
   if (Subtarget->isTargetEnvMacho()) {
@@ -681,27 +701,12 @@ void X86AsmPrinter::EmitEndOfAsmFile(Module &M) {
     // Output linker support code for dllexported globals on windows.
     if (!DLLExportedGlobals.empty() || !DLLExportedFns.empty()) {
       OutStreamer.SwitchSection(TLOFCOFF.getDrectveSection());
-      SmallString<128> name;
       for (unsigned i = 0, e = DLLExportedGlobals.size(); i != e; ++i) {
-        if (Subtarget->isTargetWindows())
-          name = " /EXPORT:";
-        else
-          name = " -export:";
-        name += DLLExportedGlobals[i]->getName();
-        if (Subtarget->isTargetWindows())
-          name += ",DATA";
-        else
-        name += ",data";
-        OutStreamer.EmitBytes(name);
+        GenerateExportDirective(DLLExportedGlobals[i], /*IsData=*/true);
       }
 
       for (unsigned i = 0, e = DLLExportedFns.size(); i != e; ++i) {
-        if (Subtarget->isTargetWindows())
-          name = " /EXPORT:";
-        else
-          name = " -export:";
-        name += DLLExportedFns[i]->getName();
-        OutStreamer.EmitBytes(name);
+        GenerateExportDirective(DLLExportedFns[i], /*IsData=*/false);
       }
     }
   }
diff --git a/lib/Target/X86/X86AsmPrinter.h b/lib/Target/X86/X86AsmPrinter.h
index 24a768b..ad95442 100644
--- a/lib/Target/X86/X86AsmPrinter.h
+++ b/lib/Target/X86/X86AsmPrinter.h
@@ -37,6 +37,8 @@ class LLVM_LIBRARY_VISIBILITY X86AsmPrinter : public AsmPrinter {
                           MachineInstr::const_mop_iterator MOE,
                           const TargetMachine &TM);
 
+  void GenerateExportDirective(const MCSymbol *Sym, bool IsData);
+
  public:
   explicit X86AsmPrinter(TargetMachine &TM, MCStreamer &Streamer)
     : AsmPrinter(TM, Streamer), SM(*this, stackmapOperandParser) {
-- 
2.9.1

